#!/usr/bin/env bash
#
#
set -u -e -o pipefail

case "$*" in
  "-h"|"--help"|"help")
    echo "$0 -h|--help|help -- Show this message."
    echo "$0 build"
    echo "$0 build dir"
    echo "$0 build css SECTION_NAME"
    echo
    ;;
  "server")
    # bunx wrangler dev
    ;;
  "build dir")
    set -x
    rm -rf build
    mkdir build
    cp -r Public build/
    ;;

  "build")
    cd "$(dirname "$0")"/..
    echo "--- in $PWD" >&2


    cd Public/style
    if ! test -e pure.css; then
      wget -O pure.css "https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/base-min.css"
    fi
    if ! test -e pure-grids.css; then
      wget -O pure-grids.css "https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css"
    fi
    
    "$0" build dir
    cd build

    echo "=== Writing file manifest..."
    www write file manifest for Public

    while read -r LINE ; do
      case "$LINE" in
        *section/base*)
          :
          ;;
        *.ts)
          echo "--- Processing .ts: $LINE"
          bun build "$LINE" --outdir "$(dirname "$LINE")"
          rm "$LINE"
          ;;
        *.css)
          echo "--- Processing .css: $LINE"
          bunx lightningcss --minify --bundle "$LINE" -o "$LINE".tmp
          mv "$LINE".tmp "$LINE"
          ;;
        *)
          ;;
      esac
    done < <( find Public/section -maxdepth 2 -mindepth 2 -type f -iname '*.css' -or -iname '*.ts')

    echo "=== Done building. ==="
    echo
    tree .
    ;;

  "build css "*)
    if ! test -e build ; then
      "$0" build dir
    fi
    section="$3"
    echo "=== Compiling section: $section"
    set -x
    cd build/Public/section/"$section"
    bunx lightningcss --minify --bundle main.css -o tmp.main.css
    mv -f tmp.main.css main.css
    ;;
  *)
    echo "!!! Unknown command: $*" >&2
    exit 1
    ;;
esac
